<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Enterprise • DC • AI — Rolling News</title>
<style>
  /* ===== Base (Dark theme) ===== */
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  body { background:#0b0f14; color:#e6edf3; }
  a { color:#8ab4ff; text-decoration:none; } a:hover { text-decoration:underline; }
  .wrap { display:flex; flex-direction:column; height:100%; }

  /* ===== Header ===== */
  header{
    padding:10px 16px; background:#0f1620; position:sticky; top:0; z-index:3;
    border-bottom:1px solid #101826; display:flex; align-items:center; gap:12px;
  }
  .brand{ font-size:18px; letter-spacing:.04em; display:flex; gap:8px; align-items:center; }
  .right{ margin-left:auto; display:flex; align-items:center; gap:10px; }
  .ts{ opacity:.75; font-size:14px; }
  .clock{ font-variant-numeric: tabular-nums; }
  .health{ width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.25); }
  .health.ok{ background:#21d07a;} .health.stale{ background:#e0a800;} .health.err{ background:#e5534b;}
  .theme-btn{ font-size:13px; padding:8px 10px; border-radius:999px; background:#121a26; color:#e6edf3; border:1px solid #101826; cursor:pointer; }

  /* ===== Main spacing ===== */
  main{ flex:1; display:flex; align-items:center; justify-content:center; padding:28px 16px 170px; }
  @media (max-height:640px){ main{ padding-bottom:200px; padding-top:32px; } }

  /* ===== Card ===== */
  .card{
    width:100%; max-width:960px; border-radius:18px;
    background:linear-gradient(180deg,#0f1620 0%,#121a26 100%);
    box-shadow:0 18px 60px rgba(0,0,0,.45);
    padding:26px 28px; margin-bottom:28px;
  }
  .kicker{ font-size:13px; text-transform:uppercase; letter-spacing:.14em; opacity:.85; margin-bottom:10px; display:flex; align-items:center; gap:10px;}
  .srcpill{ display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,.04); border:1px solid #101826; padding:6px 10px; border-radius:999px; }
  .srcpill img{ width:16px; height:16px; border-radius:3px; display:block; }
  .title{ font-size:32px; line-height:1.2; margin:0 0 10px; }
  .meta{ font-size:13px; opacity:.75; margin-bottom:12px; }
  .subhead{ font-size:19px; line-height:1.45; opacity:.95; margin:0 0 12px; font-style:italic; }
  .bodycopy{ font-size:18px; line-height:1.58; opacity:.98; margin:0; }

  /* ===== Wide footer controls (desktop/modern) ===== */
  footer{
    position:fixed; left:0; right:0; bottom:58px; z-index:3;
    display:flex; gap:10px; align-items:center; justify-content:center;
  }
  .btn{ font-size:14px; padding:10px 14px; border-radius:999px; background:#0f1620; color:#e6edf3; border:1px solid #101826; cursor:pointer; }
  .btn:active{ transform:translateY(1px); }
  .status{ font-size:12px; opacity:.75; background:#0f1620; border:1px solid #101826; border-radius:999px; padding:8px 10px; }

  /* ===== Compact floating controls (Lenovo/short) ===== */
  .controls-compact{
    position:fixed; right:12px; bottom:60px; z-index:4;
    display:none; background:#0f1620; border:1px solid #101826; border-radius:999px;
    box-shadow:0 8px 24px rgba(0,0,0,.35); padding:6px; gap:6px;
  }
  .controls-compact .cbtn{
    font-size:16px; line-height:1; padding:6px 8px; min-width:32px;
    background:#121a26; color:#e6edf3; border:1px solid #101826; border-radius:999px; cursor:pointer;
  }
  .controls-compact .cbtn:active{ transform:translateY(1px); }

  /* ===== Ticker ===== */
  .ticker{ position:fixed; bottom:0; left:0; width:100%; height:48px; background:#0f1620; border-top:1px solid #101826; white-space:nowrap; overflow:hidden; z-index:2; }
  .ticker-inner{ display:inline-block; padding:12px 0; -webkit-animation:scrollLeft 240s linear infinite; animation:scrollLeft 240s linear infinite; }
  .ticker.paused .ticker-inner{ -webkit-animation-play-state:paused; animation-play-state:paused; }
  .tick{ display:inline-block; padding:0 36px; font-size:18px; opacity:.95; }

  @-webkit-keyframes scrollLeft{ from{ -webkit-transform:translateX(0); transform:translateX(0);} to{ -webkit-transform:translateX(-50%); transform:translateX(-50%);} }
  @keyframes scrollLeft{ from{ transform:translateX(0);} to{ transform:translateX(-50%);} }

  @media (max-width:480px){ .title{font-size:24px} .subhead,.bodycopy{font-size:16px} }

  /* ===== Sepia theme ===== */
  body.sepia{ background:#19130c; color:#efe7dc; }
  body.sepia header{ background:#231a12; border-bottom-color:#3a2e21; }
  body.sepia .theme-btn{ background:#2a2017; color:#efe7dc; border-color:#3a2e21;}
  body.sepia .card{ background:linear-gradient(180deg,#231a12 0%,#2a2017 100%); box-shadow:0 18px 60px rgba(0,0,0,.45); }
  body.sepia .srcpill{ background:rgba(255,255,255,.06); border-color:#3a2e21; }
  body.sepia .btn, body.sepia .status{ background:#231a12; color:#efe7dc; border-color:#3a2e21;}
  body.sepia .controls-compact{ background:#231a12; border-color:#3a2e21;}
  body.sepia .controls-compact .cbtn{ background:#2a2017; border-color:#3a2e21;}
  body.sepia .ticker{ background:#231a12; border-top-color:#3a2e21;}
  body.sepia a{ color:#ffd27a; }

  /* ===== Lenovo YT3-850F & short-height mode ===== */
  /* Compact header: smaller fonts, less padding, hide Theme button */
  body.yt3 header{ padding:6px 10px; }
  body.yt3 .brand{ font-size:16px; letter-spacing:.03em; }
  body.yt3 .ts{ font-size:12px; }
  body.yt3 #themeBtn{ display:none; }
  /* Tighter, smaller typography */
  body.yt3 .title{ font-size:26px; }
  body.yt3 .subhead{ font-size:17px; }
  body.yt3 .bodycopy{ font-size:17px; line-height:1.52; }
  /* Spacing: extra top/btm to dodge URL/ticker; hide wide footer; show compact pill */
  body.yt3 main{ padding-top:56px; padding-bottom:250px; }
  body.yt3 footer{ display:none; }
  body.yt3 .controls-compact{ display:flex; }
  @media (max-height:820px){
    body.yt3 main{ padding-top:62px; padding-bottom:270px; }
  }
  @media (max-height:700px){
    body.yt3 main{ padding-top:70px; padding-bottom:290px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><strong>Enterprise • Data Center • AI</strong> — Rolling News Display</div>
    <div class="right">
      <div class="health ok" id="health" title="Status"></div>
      <div class="ts"><span class="clock" id="clock">--:--:--</span> • <span id="ts">Booting…</span></div>
      <button class="theme-btn" id="themeBtn" aria-label="Toggle theme">Theme: Dark</button>
    </div>
  </header>

  <main>
    <article class="card" id="card" aria-live="polite">
      <div class="kicker">
        <span class="srcpill" id="srcpill">
          <img id="favicon" alt="" src="">
          <span id="sourceText">source</span>
        </span>
      </div>
      <h1 class="title" id="title">Loading…</h1>
      <div class="meta" id="meta"></div>
      <p class="subhead" id="subhead"></p>
      <p class="bodycopy" id="body"></p>
    </article>
  </main>

  <!-- Wide footer (hidden on YT3) -->
  <footer>
    <button class="btn" id="prevBtn">◀ Prev</button>
    <button class="btn" id="pauseBtn">⏸ Pause</button>
    <button class="btn" id="nextBtn">Next ▶</button>
    <div class="status" id="status">—</div>
  </footer>

  <!-- Compact floating controls (shown on YT3) -->
  <div class="controls-compact" id="compactCtl" aria-label="Controls">
    <button class="cbtn" id="cPrev" title="Previous">◀</button>
    <button class="cbtn" id="cPause" title="Pause/Resume">▌▌</button>
    <button class="cbtn" id="cNext" title="Next">▶</button>
  </div>

  <div class="ticker" id="ticker" aria-live="polite" aria-label="Top headlines ticker">
    <div class="ticker-inner" id="tickerInner"></div>
  </div>
</div>

<script>
(function(){
  /* ===== Version ===== */
  var APP_VERSION = 'v1.9.6-yt3-compactheader';

  /* ===== Config (GitHub Pages) ===== */
  var FEEDS_URL = location.origin + location.pathname.replace(/\/[^/]*$/, '/') + 'feeds.json?v=' + APP_VERSION;
  var REFRESH_MS = 10 * 60 * 1000;   // re-download JSON every 10 min
  var ROTATE_MS  = 15 * 1000;        // 15s per card
  var MAX_ITEMS  = 140;

  var TICKER_MAX = 6;
  var TICKER_HOURS = 24;
  var TICKER_SECONDS = 240;

  var STALE_MIN = 20; // minutes

  /* ===== Device detection: Lenovo YT3-850F + short viewports ===== */
  function applyDeviceClass(){
    var ua = (navigator.userAgent || '').toUpperCase();
    var isYT3 = ua.indexOf('YT3-850F') !== -1 || ua.indexOf('YT3_850F') !== -1;
    if (isYT3) document.body.className += (document.body.className?' ':'') + 'yt3';
    if (window.innerHeight <= 820) {
      if (document.body.className.indexOf('yt3') === -1)
        document.body.className += (document.body.className?' ':'') + 'yt3';
    }
  }
  applyDeviceClass();
  window.addEventListener('orientationchange', function(){ setTimeout(adjustSafeInsets, 200); }, false);
  window.addEventListener('resize', function(){ setTimeout(adjustSafeInsets, 200); }, false);

  /* ===== State ===== */
  var items=[], idx=0, paused=false, timer=null;
  var lastFetchOK = true, lastFetchAt = 0;

  /* ===== Helpers (ES5-safe) ===== */
  function $(id){ return document.getElementById(id); }
  function setStatus(s){ var el=$('status'); if(el) el.textContent = s + ' • ' + APP_VERSION; }
  function setHeaderStatus(){
    var ts = $('ts'), h = $('health');
    if (!ts || !h) return;
    if (!lastFetchAt) { ts.textContent='Booting…'; h.className='health stale'; h.title='Booting'; return; }
    var ageMin = Math.floor((Date.now()-lastFetchAt)/60000);
    ts.textContent = 'Stories: '+items.length+' • Updated: '+new Date(lastFetchAt).toLocaleTimeString('en-GB')+' • '+APP_VERSION;
    if (!lastFetchOK) { h.className='health err'; h.title='Fetch error'; }
    else if (ageMin > STALE_MIN) { h.className='health stale'; h.title='Stale ('+ageMin+'m)'; }
    else { h.className='health ok'; h.title='Fresh ('+ageMin+'m)'; }
  }

  // Safe hostname parsing (no new URL())
  var _a = document.createElement('a');
  function host(u){ if(!u) return ''; try{ _a.href=u; return (_a.hostname||'').replace(/^www\./,''); }catch(e){ return ''; } }

  // Strip tags & bullets
  function htmlToTextNoBullets(s){
    if (!s) return '';
    var div=document.createElement('div'); div.innerHTML=String(s);
    var txt=(div.textContent||div.innerText||'')||'';
    txt=txt.replace(/<[^>]*>/g,' ');
    txt=txt.replace(/\r?\n+/g,'\n');
    var bulletStart=/^(?:\s*[\u2022\u2219\u25CF\u25A0\u25AA\u00B7\-\*\u2013\u2014]+|\s*(?:\(?[0-9a-zA-Z]\)?[.)]))\s+/gm;
    txt=txt.replace(bulletStart,'');
    txt=txt.replace(/[\u2022\u00B7\u25CF\u25A0]+/g,' ');
    txt=txt.replace(/[ \t]+/g,' ').replace(/\s*\n\s*/g,' ').trim();
    return txt;
  }
  function clampWords(s,n){ var t=htmlToTextNoBullets(s); var w=t.split(/\s+/); var out=w.slice(0,n).join(' '); return out+(w.length>n?'…':''); }
  function wordCount(s){ return htmlToTextNoBullets(s).split(/\s+/).filter(Boolean).length; }

  function parseDate(x){ var d=new Date(x); return isNaN(d.getTime())? new Date(): d; }
  function withinHours(d,h){ return (Date.now()-d.getTime()) <= h*3600*1000; }
  function escapeHTML(s){ return String(s).replace(/[&<>\"]/g,function(c){return {"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;"}[c];}); }

  // Dedupe helpers
  function norm(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9 ]+/g,' ').replace(/\s+/g,' ').trim(); }
  function tokenSet(s){ var o={}, a=norm(s).split(' '), i; for(i=0;i<a.length;i++){ if(a[i]) o[a[i]]=1; } return o; }
  function jaccard(a,b){ var A=tokenSet(a),B=tokenSet(b),inter=0,uni=0,k; for(k in A){ if(A.hasOwnProperty(k)){ uni++; if(B[k]) inter++; }} for(k in B){ if(B.hasOwnProperty(k)&&!A[k]) uni++; } return uni? inter/uni:0; }
  function shortHash(s){ var t=norm(s),i,h=0; for(i=0;i<t.length;i++){ h=((h<<5)-h)+t.charCodeAt(i); h|=0;} return (h>>>0).toString(36).slice(0,12); }

  // Legacy-safe sentence split
  function splitSentences(text){
    var t=htmlToTextNoBullets(text);
    var parts=t.split(/([.!?])\s+/), out=[], i, buf='';
    for(i=0;i<parts.length;i++){ if(i%2===0){ buf+=parts[i]; } else { buf+=parts[i]; out.push(buf); buf=''; } }
    if(buf.trim()) out.push(buf); return out;
  }

  function buildSubAndBody(title, raw, sourceHost){
    var sentences = splitSentences(raw || title || '');
    if (sentences.length < 2) { sentences = (htmlToTextNoBullets(raw||title||'')).split(/[;,:]\s+/); }
    var sub='', bodyText='', i, j;
    for(i=0;i<sentences.length;i++){ var s=sentences[i].trim(); if(s.length<15) continue; if(jaccard(s,title)>0.7) continue; sub=clampWords(s,30); break; }
    var acc=[];
    for(j=0;j<sentences.length;j++){ var t=sentences[j].trim(); if(t.length<15) continue; if(jaccard(t,title)>0.7) continue; if(sub&&jaccard(t,sub)>0.7) continue; acc.push(t); if(acc.join(' ').split(/\s+/).length>=200) break; }
    bodyText=clampWords(acc.join(' '),150);
    if(wordCount(bodyText)<120){
      var generic="Context: This update reflects activity across enterprise IT, data center infrastructure, and AI adoption. "+
                  "Implications: Teams may weigh performance, cost, security, and integration with cloud or on-prem stacks. "+
                  "Considerations: Availability, support, partner ecosystems, and licensing often shape near-term choices. "+
                  "Next steps: For specifics, benchmarks, and timelines, read the source article and vendor materials. ";
      var safeTail="Note: The feed was terse; additional text adds neutral context without new facts. ";
      var pad=(sub?"":"Summary: ")+generic+safeTail+(sourceHost?("Source: "+sourceHost+". "):"");
      bodyText=clampWords(bodyText+" "+pad,155);
    }
    if(!sub){ sub=clampWords(bodyText,30); if(jaccard(sub,bodyText)>0.8){ sub=clampWords(htmlToTextNoBullets(raw||title||''),30);} }
    return { subhead: sub, body: bodyText };
  }

  // Parse RSS/Atom XML strings from feeds.json
  function parseFeedXML(xmlText, sourceUrl){
    var parser=new DOMParser(); var doc=parser.parseFromString(xmlText,'application/xml'); var out=[];
    var rss=doc.getElementsByTagName('item');
    if(rss && rss.length){
      for(var i=0;i<rss.length;i++){
        var it=rss[i];
        var title=getText(it,'title');
        var link=getText(it,'link');
        var desc=getRaw(it,'description');
        var date=getText(it,'pubDate');
        var src=host(link)||host(sourceUrl);
        out.push({ title:title, link:link, raw:desc||title, published:parseDate(date), source:src });
      }
      return out;
    }
    var entries=doc.getElementsByTagName('entry');
    for(var j=0;j<entries.length;j++){
      var en=entries[j];
      var titleA=getText(en,'title');
      var linkEl=en.getElementsByTagName('link')[0];
      var href=(linkEl&&(linkEl.getAttribute('href')||linkEl.textContent))||'';
      var sumA=getRaw(en,'summary')||getRaw(en,'content');
      var dateA=getText(en,'updated')||getText(en,'published');
      var srcA=host(href)||host(sourceUrl);
      out.push({ title:titleA, link:href, raw:sumA||titleA, published:parseDate(dateA), source:srcA });
    }
    return out;
    function getText(parent,tag){ var el=parent.getElementsByTagName(tag)[0]; if(!el) return ''; return (el.textContent||el.innerText||'').trim(); }
    function getRaw(parent,tag){
      var el=parent.getElementsByTagName(tag)[0]; if(!el) return '';
      var t=''; if(el.childNodes&&el.childNodes.length){ for(var i=0;i<el.childNodes.length;i++){ var n=el.childNodes[i]; t+=(n.outerHTML||n.nodeValue||''); } }
      else { t=el.textContent||el.innerText||''; } return (t||'').trim();
    }
  }

  // Smart de-dupe
  function dedupeSmart(arr){
    var out=[], seenTitles=[], seenHashes={}, i, it, t, h;
    for(i=0;i<arr.length;i++){
      it=arr[i]; t=it.title||''; h=shortHash((it.raw||'').slice(0,600));
      var key=((it.link||'')+'|'+t).toLowerCase();
      if(seenHashes[key]) continue;
      var dupe=false; for(var j=0;j<seenTitles.length;j++){ if(jaccard(t,seenTitles[j])>0.85){ dupe=true; break; } }
      if(dupe) continue; if(h&&seenHashes[h]) continue;
      out.push(it); seenTitles.push(t); seenHashes[key]=1; if(h) seenHashes[h]=1;
    }
    return out;
  }

  // Build final display item
  function buildItem(raw){
    var pieces=buildSubAndBody(raw.title, raw.raw, raw.source);
    return { title:raw.title, link:raw.link, source:raw.source, subhead:pieces.subhead, body:pieces.body, published:raw.published };
  }

  // XHR helper
  function xhrJSON(url, cb){
    var x=new XMLHttpRequest(); x.open('GET', url, true); x.timeout=15000;
    x.onreadystatechange=function(){ if(x.readyState===4){ try{ if(x.status>=200&&x.status<300){ cb(null, JSON.parse(x.responseText)); } else { cb(new Error('HTTP '+x.status)); } } catch(e){ cb(e);} } };
    x.ontimeout=function(){ cb(new Error('Timeout')); }; x.send();
  }

  // Cache
  var CACHE_KEY='tnd_feeds_cache_v1', CACHE_IDX='tnd_last_idx_v1';
  function saveCache(obj){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ when:Date.now(), data:obj })); }catch(e){} }
  function loadCache(){ try{ var s=localStorage.getItem(CACHE_KEY); if(!s) return null; return JSON.parse(s); }catch(e){ return null; } }
  function saveIdx(i){ try{ localStorage.setItem(CACHE_IDX, String(i)); }catch(e){} }
  function loadIdx(){ var s=localStorage.getItem(CACHE_IDX); return s? (parseInt(s,10)||0):0; }

  // Theme
  var THEME_KEY='tnd_theme';
  function applyTheme(theme){
    var body=document.body;
    if(theme==='sepia'){ if(body.className.indexOf('sepia')===-1) body.className+=(body.className?' ':'')+'sepia'; $('themeBtn') && ($('themeBtn').textContent='Theme: Sepia'); }
    else { body.className=body.className.replace(/\bsepia\b/g,'').replace(/\s{2,}/g,' ').trim(); $('themeBtn') && ($('themeBtn').textContent='Theme: Dark'); }
    try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
  }
  var themeBtn=$('themeBtn'); if(themeBtn){ themeBtn.onclick=function(){ var cur=(localStorage.getItem(THEME_KEY)||'dark'); applyTheme(cur==='dark'?'sepia':'dark'); }; }
  applyTheme(localStorage.getItem(THEME_KEY)||'dark');

  // Clock
  function tickClock(){ var c=$('clock'); if(c) c.textContent=new Date().toLocaleTimeString('en-GB'); }
  setInterval(tickClock,1000); tickClock();

  // Ticker
  function updateTicker(list){
    var t=$('ticker'), inner=$('tickerInner'); if(!t||!inner) return;
    var recent=[], i, j, k;
    for(i=0;i<list.length;i++){ if(withinHours(list[i].published, TICKER_HOURS)) recent.push(list[i]); if(recent.length>=TICKER_MAX) break; }
    if(recent.length<TICKER_MAX){ for(j=0;j<list.length && recent.length<TICKER_MAX; j++){ var dupe=false; for(k=0;k<recent.length;k++){ if(recent[k].title===list[j].title && recent[k].source===list[j].source){ dupe=true; break; } } if(!dupe) recent.push(list[j]); } }
    var html=[], m; for(m=0;m<recent.length;m++){ html.push('<span class="tick">'+escapeHTML(recent[m].source)+' · '+escapeHTML(recent[m].title)+'</span>'); }
    inner.innerHTML=html.join('')+html.join(''); inner.style.webkitAnimationDuration=TICKER_SECONDS+'s'; inner.style.animationDuration=TICKER_SECONDS+'s';
    function togglePause(){ if(t.className.indexOf('paused')===-1) t.className+=' paused'; else t.className=t.className.replace(' paused',''); }
    t.onmouseenter=togglePause; t.onmouseleave=togglePause; t.onclick=togglePause;
  }

  // Render
  function setFavicon(hostname){
    var ico='https://www.google.com/s2/favicons?sz=64&domain='+encodeURIComponent('https://'+(hostname||''));
    var img=$('favicon'), st=$('sourceText'); if(img) img.src=ico; if(st) st.textContent=hostname||'source';
  }
  function render(){
    if(!items.length) return;
    var it=items[idx%items.length];
    setFavicon(it.source||'');
    $('title').innerHTML='<a href="'+it.link+'" target="_blank" rel="noopener">'+escapeHTML(it.title)+'</a>';
    $('meta').textContent=it.published.toLocaleString('en-GB');
    $('subhead').textContent=it.subhead||'';
    $('body').textContent=it.body||'';
    saveIdx(idx); setHeaderStatus();
    adjustSafeInsets();
  }
  function next(){ idx=(idx+1)%items.length; render(); }
  function prev(){ idx=(idx-1+items.length)%items.length; render(); }
  function startRotate(){ if(timer) clearInterval(timer); timer=setInterval(function(){ if(!paused&&items.length) next(); }, ROTATE_MS); }

  // Auto top-inset adjustment (legacy-safe)
  function adjustSafeInsets(){
    try{
      var hdr=document.getElementsByTagName('header')[0];
      var mainEl=document.getElementsByTagName('main')[0];
      if(!hdr||!mainEl) return;
      var hb=hdr.getBoundingClientRect().bottom;   // header bottom in viewport
      var card=document.getElementById('card');
      if(!card) return;
      var ct=card.getBoundingClientRect().top;
      var needed = hb + 8; // want at least 8px gap below header
      if(ct < needed){
        var extra = Math.ceil(needed - ct);
        // Bump top padding, but clamp to a reasonable maximum
        var cur = parseInt(mainEl.style.paddingTop||window.getComputedStyle(mainEl).paddingTop,10) || 0;
        var target = Math.min(cur + extra + 6, 120); // cap extra to avoid runaway
        mainEl.style.paddingTop = target + 'px';
      }
    }catch(_e){}
  }

  // Data pipeline
  function useData(data){
    try{
      var merged=[], results=(data&&data.results)||[], r,i;
      for(i=0;i<results.length;i++){ r=results[i]; if(!r.ok) continue; merged=merged.concat(parseFeedXML(r.text, r.url)); }
      merged=dedupeSmart(merged).sort(function(a,b){ return b.published-a.published; }).slice(0,MAX_ITEMS);
      var built=[], ii; for(ii=0; ii<merged.length; ii++){ built.push(buildItem(merged[ii])); }
      items=built; var li=loadIdx(); if(li && li<items.length) idx=li; else idx=0;
      render(); updateTicker(items); saveCache(data);
      lastFetchOK=true; lastFetchAt=Date.now(); setStatus('Updated '+items.length+' items');
    }catch(e){ setStatus('Parse error: '+e); lastFetchOK=false; setHeaderStatus(); }
  }
  function refresh(){
    setStatus('Refreshing…');
    xhrJSON(FEEDS_URL+'&t='+Date.now(), function(err,data){
      if(err || !data){
        var cache=loadCache(); lastFetchOK=false;
        if(cache && cache.data){ useData(cache.data); setStatus('Offline • using cached feeds'); }
        else { setStatus('Fetch error and no cache'); }
        setHeaderStatus(); return;
      }
      useData(data);
    });
  }

  // Wire both control UIs
  function hookControls(){
    var widePrev=$('prevBtn'), widePause=$('pauseBtn'), wideNext=$('nextBtn');
    var cPrev=$('cPrev'), cPause=$('cPause'), cNext=$('cNext');

    function doPrev(){ paused=true; if(widePause) widePause.textContent='▶ Resume'; if(cPause) cPause.textContent='▶'; prev(); }
    function doNext(){ paused=true; if(widePause) widePause.textContent='▶ Resume'; if(cPause) cPause.textContent='▶'; next(); }
    function doPause(){ paused=!paused; if(widePause) widePause.textContent=paused?'▶ Resume':'⏸ Pause'; if(cPause) cPause.textContent=paused?'▶':'▌▌'; }

    if(widePrev) widePrev.onclick=doPrev; if(wideNext) wideNext.onclick=doNext; if(widePause) widePause.onclick=doPause;
    if(cPrev) cPrev.onclick=doPrev; if(cNext) cNext.onclick=doNext; if(cPause) cPause.onclick=doPause;
  }
  hookControls();

  // Init
  refresh(); startRotate(); setInterval(refresh, REFRESH_MS);
  var cached=loadCache(); if(cached && cached.data){ try{ useData(cached.data); }catch(_e){} }

  // also adjust once on boot (in case of cached render)
  setTimeout(adjustSafeInsets, 300);
})();
</script>
</body>
</html>
