<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Enterprise • DC • AI — Rolling News</title>
<style>
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  body { background:#0b0f14; color:#e6edf3; }
  .wrap { display:flex; flex-direction:column; height:100%; }
  header { padding:10px 16px; font-size:18px; letter-spacing:.04em; background:#0f1620; position:sticky; top:0; z-index:2; }
  header .ts { opacity:.7; font-size:14px; }
  main { flex:1; display:flex; align-items:center; justify-content:center; padding:16px; }
  .card { width:100%; max-width:860px; border-radius:16px; background:#0f1620; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:22px 24px; }
  .kicker { font-size:14px; text-transform:uppercase; letter-spacing:.14em; opacity:.7; margin-bottom:8px; }
  .title { font-size:28px; line-height:1.2; margin:0 0 8px; }
  .meta { font-size:13px; opacity:.7; margin-bottom:12px; }
  .subhead { font-size:18px; line-height:1.4; opacity:.9; margin: 0 0 10px; font-style:italic; }
  .bodycopy { font-size:18px; line-height:1.55; opacity:.95; margin:0; }
  footer { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px 16px; background:#0b0f14; border-top:1px solid #101826; }
  .btn { font-size:14px; padding:10px 14px; border-radius:999px; background:#1a2332; color:#e6edf3; border:0; cursor:pointer; }
  .status { font-size:12px; opacity:.7; }
  a { color:#8ab4ff; text-decoration:none; } a:hover { text-decoration:underline; }

  /* Ticker: larger + slower */
  .ticker { position:fixed; bottom:0; left:0; width:100%; background:#0f1620; border-top:1px solid #101826; white-space:nowrap; overflow:hidden; }
  .ticker-inner { display:inline-block; padding:12px 0; animation:scrollLeft 240s linear infinite; }
  .tick { display:inline-block; padding:0 36px; font-size:18px; opacity:.95; }
  @keyframes scrollLeft { from { transform: translateX(0); } to { transform: translateX(-50%); } }

  @media (max-width:480px){ .title{font-size:22px} .subhead,.bodycopy{font-size:16px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div><strong>Enterprise • Data Center • AI</strong> — Rolling News Display</div>
    <div class="ts" id="ts">Loading…</div>
  </header>
  <main>
    <article class="card" id="card" aria-live="polite">
      <div class="kicker" id="kicker">Just a sec…</div>
      <h1 class="title" id="title">Loading…</h1>
      <div class="meta" id="meta"></div>
      <p class="subhead" id="subhead"></p>
      <p class="bodycopy" id="body"></p>
    </article>
  </main>
  <footer>
    <div>
      <button class="btn" id="prevBtn">◀ Prev</button>
      <button class="btn" id="pauseBtn">⏸ Pause</button>
      <button class="btn" id="nextBtn">Next ▶</button>
    </div>
    <div class="status" id="status">—</div>
  </footer>
  <div class="ticker" aria-hidden="true"><div class="ticker-inner" id="ticker"></div></div>
</div>

<script>
(function(){
  /* ===== Version (visible in header & footer) ===== */
  var APP_VERSION = 'v1.7-sub30-body150';

  /* ===== Config (GitHub Pages) ===== */
  var FEEDS_URL = location.origin + location.pathname.replace(/\/[^/]*$/, '/') + 'feeds.json?v=' + APP_VERSION;
  var REFRESH_MS = 10 * 60 * 1000;   // re-download JSON every 10 min
  var ROTATE_MS  = 15 * 1000;        // 15s per card
  var MAX_ITEMS  = 120;

  // Ticker controls
  var TICKER_MAX = 6;        // up to 6 headlines
  var TICKER_HOURS = 24;     // last 24 hours
  var TICKER_SECONDS = 240;  // slow scroll (also set in CSS)

  /* ===== Helpers (ES5-safe) ===== */
  function $(id){ return document.getElementById(id); }

  // Strip tags, decode entities, and REMOVE bullet/number markers entirely.
  function htmlToTextNoBullets(s){
    if (!s) return '';
    var div = document.createElement('div');
    div.innerHTML = String(s);
    var txt = (div.textContent || div.innerText || '') || '';
    txt = txt.replace(/<[^>]*>/g,' ');
    txt = txt.replace(/\r?\n+/g, '\n');
    var bulletStart = /^(?:\s*[\u2022\u2219\u25CF\u25A0\u25AA\u00B7\-\*\u2013\u2014]+|\s*(?:\(?[0-9a-zA-Z]\)?[.)]))\s+/gm;
    txt = txt.replace(bulletStart, '');
    txt = txt.replace(/[\u2022\u00B7\u25CF\u25A0]+/g, ' ');
    txt = txt.replace(/[ \t]+/g,' ').replace(/\s*\n\s*/g, ' ').trim();
    return txt;
  }

  function clampWords(s, n){
    var t = htmlToTextNoBullets(s);
    var w = t.split(/\s+/);
    var out = w.slice(0, n).join(' ');
    return out + (w.length > n ? '…' : '');
  }

  function wordCount(s){ return htmlToTextNoBullets(s).split(/\s+/).filter(Boolean).length; }

  function parseDate(x){ var d=new Date(x); return isNaN(d.getTime())? new Date() : d; }
  function withinHours(d,h){ return (Date.now()-d.getTime()) <= h*3600*1000; }
  function host(u){ try{ return new URL(u).host.replace(/^www\./,''); }catch(e){ return ''; } }
  function uniqueByLinkTitle(a){ var seen={},out=[]; for(var i=0;i<a.length;i++){ var k=((a[i].link||'')+'|'+(a[i].title||'')).toLowerCase(); if(!seen[k]){ seen[k]=1; out.push(a[i]); } } return out; }
  function byDateDesc(a,b){ return b.published - a.published; }
  function escapeHTML(s){ return String(s).replace(/[&<>\"]/g,function(c){return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c];}); }

  // Similarity helpers
  function norm(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9 ]+/g,' ').replace(/\s+/g,' ').trim(); }
  function overlapRatio(a,b){
    var wa=norm(a).split(' '), wb=norm(b).split(' '), set={}, inter=0, i;
    for(i=0;i<wa.length;i++) set[wa[i]]=1;
    for(i=0;i<wb.length;i++) if(set[wb[i]]) inter++;
    var denom=Math.max(wa.length, wb.length) || 1;
    return inter/denom;
  }
  function tooSimilar(a,b){ return overlapRatio(a,b) > 0.75 || norm(b).indexOf(norm(a))!==-1 || norm(a).indexOf(norm(b))!==-1; }

  // Build sub-head (≤30 words) and body (≤150 words) from raw summary/content
  function buildSubAndBody(title, raw){
    var txt = htmlToTextNoBullets(raw || title || '');

    // Split into sentences; tolerate weak punctuation
    var sentences = txt.split(/(?<=[.!?])\s+/);
    if (sentences.length < 2) sentences = txt.split(/[;,:]\s+/);

    var sub = '', bodyText = '';

    // Pick sub-head: first sentence not too similar to the title
    for (var i=0;i<sentences.length;i++){
      var s = sentences[i].trim();
      if (s.length < 15) continue;
      if (tooSimilar(s, title)) continue;
      sub = clampWords(s, 30); // ≤30 words
      break;
    }

    // Body: the rest, skipping near-duplicates of title/sub-head
    var acc = [];
    for (var j=0;j<sentences.length;j++){
      var t = sentences[j].trim();
      if (t.length < 15) continue;
      if (tooSimilar(t, title)) continue;
      if (sub && tooSimilar(t, sub)) continue;
      acc.push(t);
      if (acc.join(' ').split(/\s+/).length >= 180) break; // collect a bit more; clamp later
    }
    bodyText = clampWords(acc.join(' '), 150); // ≤150 words

    // If body still too short (some feeds are extremely terse), backfill from the full cleaned text
    if (wordCount(bodyText) < 60) {
      var fallback = txt;
      if (sub) fallback = fallback.replace(sub, ''); // avoid repeating
      bodyText = clampWords((acc.join(' ') + ' ' + fallback), 150);
    }

    // If no sub-head, derive from the start of body
    if (!sub) {
      sub = clampWords(bodyText, 30);
      if (tooSimilar(sub, bodyText)) bodyText = clampWords(txt, 150);
    }
    return { subhead: sub, body: bodyText };
  }

  // Parse RSS/Atom XML strings from feeds.json
  function parseFeedXML(xmlText, sourceUrl){
    var parser=new DOMParser(); var doc=parser.parseFromString(xmlText,'application/xml'); var out=[];
    var rss=doc.getElementsByTagName('item');
    if(rss && rss.length){
      for(var i=0;i<rss.length;i++){
        var it=rss[i];
        var title = getText(it,'title');
        var link  = getText(it,'link');
        var desc  = getRaw(it,'description');    // raw; we clean later
        var date  = getText(it,'pubDate');
        var src   = host(link) || host(sourceUrl);
        out.push({ title:title, link:link, raw:desc || title, published:parseDate(date), source:src });
      }
      return out;
    }
    var entries=doc.getElementsByTagName('entry');
    for(var j=0;j<entries.length;j++){
      var en=entries[j];
      var titleA = getText(en,'title');
      var linkEl = en.getElementsByTagName('link')[0];
      var href   = (linkEl && (linkEl.getAttribute('href')||linkEl.textContent)) || '';
      var sumA   = getRaw(en,'summary') || getRaw(en,'content');
      var dateA  = getText(en,'updated') || getText(en,'published');
      var srcA   = host(href) || host(sourceUrl);
      out.push({ title:titleA, link:href, raw:sumA || titleA, published:parseDate(dateA), source:srcA });
    }
    return out;

    function getText(parent, tag){
      var el = parent.getElementsByTagName(tag)[0];
      if (!el) return '';
      return (el.textContent || el.innerText || '').trim();
    }
    function getRaw(parent, tag){
      var el = parent.getElementsByTagName(tag)[0];
      if (!el) return '';
      var t=''; if(el.childNodes&&el.childNodes.length){
        for (var i=0;i<el.childNodes.length;i++){ var n=el.childNodes[i]; t+=(n.outerHTML||n.nodeValue||''); }
      } else { t = el.textContent || el.innerText || ''; }
      return (t||'').trim();
    }
  }

  // Build final display item
  function buildItem(raw){
    var pieces = buildSubAndBody(raw.title, raw.raw);
    return {
      title: raw.title,
      link: raw.link,
      source: raw.source,
      subhead: pieces.subhead,
      body: pieces.body,
      published: raw.published
    };
  }

  // XHR helper
  function xhrJSON(url, cb){
    var x=new XMLHttpRequest();
    x.open('GET', url, true);
    x.onreadystatechange=function(){
      if(x.readyState===4){
        try{
          if(x.status>=200 && x.status<300){ cb(null, JSON.parse(x.responseText)); }
          else { cb(new Error('HTTP '+x.status)); }
        } catch(e){ cb(e); }
      }
    };
    x.send();
  }

  function setStatus(m){
    var s=$('status'); if(s) s.textContent = m + ' • ' + APP_VERSION;
  }

  // Ticker (≤6 headlines, last 24h, slow scroll)
  function updateTicker(list){
    var t=$('ticker'); if(!t) return;
    var recent=[], i, j, k;

    for (i=0;i<list.length;i++){
      if (withinHours(list[i].published, TICKER_HOURS)) recent.push(list[i]);
      if (recent.length >= TICKER_MAX) break;
    }
    if (recent.length < TICKER_MAX){
      for (j=0;j<list.length && recent.length<TICKER_MAX; j++){
        var dupe=false;
        for(k=0;k<recent.length;k++){
          if (recent[k].title===list[j].title && recent[k].source===list[j].source){ dupe=true; break; }
        }
        if(!dupe) recent.push(list[j]);
      }
    }

    var texts=[];
    for(i=0;i<recent.length;i++){
      texts.push('<span class="tick">'+escapeHTML(recent[i].source)+' · '+escapeHTML(recent[i].title)+'</span>');
    }
    t.innerHTML = '<div class="ticker-inner" id="tickerInner">' + texts.join('') + texts.join('') + '</div>';
    var inner=$('tickerInner'); if(inner) inner.style.animationDuration = TICKER_SECONDS + 's';
  }

  /* ===== App state / UI ===== */
  var items=[], idx=0, paused=false, timer=null;

  function render(){
    if(!items.length) return;
    var it=items[idx%items.length];
    $('kicker').textContent = it.source || '';
    $('title').innerHTML = '<a href="'+it.link+'" target="_blank" rel="noopener">'+escapeHTML(it.title)+'</a>';
    $('meta').textContent = it.published.toLocaleString('en-GB');
    $('subhead').textContent = it.subhead || '';
    $('body').textContent = it.body || '';

    // Header status shows version prominently
    var ts=$('ts');
    if (ts) ts.textContent = 'Stories: '+items.length+' • Updated: '+(new Date()).toLocaleTimeString('en-GB')+' • '+APP_VERSION;
  }
  function next(){ idx=(idx+1)%items.length; render(); }
  function prev(){ idx=(idx-1+items.length)%items.length; render(); }
  function startRotate(){ if(timer) clearInterval(timer); timer=setInterval(function(){ if(!paused&&items.length) next(); }, ROTATE_MS); }

  /* ===== Refresh pipeline ===== */
  function refresh(){
    setStatus('Refreshing…');
    xhrJSON(FEEDS_URL + '&t=' + Date.now(), function(err, data){
      if(err){ return setStatus('Feed error: '+err); }
      try{
        var merged=[], results=(data&&data.results)||[], r, i;
        for(i=0;i<results.length;i++){
          r=results[i]; if(!r.ok) continue;
          merged = merged.concat(parseFeedXML(r.text, r.url));
        }
        merged = uniqueByLinkTitle(merged).sort(byDateDesc).slice(0, MAX_ITEMS);

        var built=[], ii;
        for(ii=0; ii<merged.length; ii++){ built.push(buildItem(merged[ii])); }
        items=built; idx=0; render(); updateTicker(items);
        setStatus('Updated '+items.length+' items');
      }catch(e){ setStatus('Parse error: '+e); }
    });
  }

  // Buttons
  $('nextBtn').onclick=function(){ paused=true; $('pauseBtn').textContent='▶ Resume'; next(); };
  $('prevBtn').onclick=function(){ paused=true; $('pauseBtn').textContent='▶ Resume'; prev(); };
  $('pauseBtn').onclick=function(){ paused=!paused; this.textContent=paused?'▶ Resume':'⏸ Pause'; };

  // Init
  refresh(); startRotate(); setInterval(refresh, REFRESH_MS);
})();
</script>
</body>
</html>
